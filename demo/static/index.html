<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" type="text/css" href="static/c3.css">
    <link rel="stylesheet" type="text/css" href="static/bootstrap.min.css">
    <title>GigaSpire Real-Time WiFi Status</title>
    <style>
      .table-wrapper-scroll-y {
        display: block;
        max-height: 200px;
        overflow-y: auto;
        -ms-overflow-style: -ms-autohiding-scrollbar;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h4>GigaSpire Real-Time WiFi Status</h4>
      <div id="chart"></div>
      <h4>Most Recent Events</h4>
      <div id="table" class="table-wrapper-scroll-y">
        <table class="table table-hover table-bordered table-striped table-sm">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Message</th>
             </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <h4>Current Metrics</h4>
      <div id="metrics" class="code-block">
        <pre>
        </pre>
      </div>
    </div>

    <script src="static/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="static/bootstrap.bundle.min.js" charset="utf-8"></script>
    <script src="static/d3-5.4.0.min.js" charset="utf-8"></script>
    <script src="static/c3.min.js" charset="utf-8"></script>
    <script>
      function formatXml(xml) {
        var formatted = '';
        var reg = /(>)(<)(\/*)/g;
        xml = xml.replace(reg, '$1\r\n$2$3');
        var pad = 0;
        jQuery.each(xml.split('\r\n'), function(index, node) {
          var indent = 0;
          if (node.match( /.+<\/\w[^>]*>$/ )) {
            indent = 0;
          } else if (node.match( /^<\/\w/ )) {
            if (pad != 0) {
              pad -= 1;
            }
          } else if (node.match( /^<\w[^>]*[^\/]>.*$/ )) {
            indent = 1;
          } else {
            indent = 0;
          }

          var padding = '';
          for (var i = 0; i < pad; i++) {
            padding += '  ';
          }

          formatted += padding + node + '\r\n';
          pad += indent;
        });

        return formatted;
      }

      var num_entries_added = 0;
      var chart = c3.generate({
        bindto: '#chart',
        data: {
          x : 'time',
          xFormat : '%H%M%S',
          columns: [
              ['time']
          ]
        },
        axis : {
          x : {
            type : 'timeseries',
            tick : {
              format : "%H:%M:%S" // https://github.com/mbostock/d3/wiki/Time-Formatting#wiki-format
            }
          }
        }
      });

      setInterval(function () {
        $.get('/wifi').done(function(data) {
          metrics = $.parseJSON(data);
          shift_len = (num_entries_added > 200) ? 1 : 0;
          chart.flow({
            columns: metrics,
            length: shift_len
          });
          num_entries_added += 1
        });
      }, 5000);

      setInterval(function () {
        $.get('/metrics').done(function(data) {
          $('#metrics pre').text(formatXml(data));
        });
      }, 5000);

      function createWebSocket(path) {
        var protocolPrefix = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
        return new WebSocket(protocolPrefix + '//' + location.host + path);
      }

      function start(websocketServerLocation) {
        ws = new createWebSocket(websocketServerLocation);
        ws.onclose = function(){
          // Try to reconnect in 5 seconds
          setTimeout(function(){start(websocketServerLocation)}, 5000);
        };
        ws.onmessage = function (event) {
          console.log(event.data);
          evt = $.parseJSON(event.data);
          var $tr = $('<tr>').append(
            $('<td>').text(evt.time),
            $('<td>').text(evt.event + " " + evt.mac)
          );
          $('#table tbody').prepend($tr);
        };
      }

      start("/websocket");

    </script>
  </body>
</html>

